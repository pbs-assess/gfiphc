---
title: "Extract and analyse the IPHC data for predators of Haida Gwaii Pacific Herring"
author: "Andrew Edwards"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Extract the IPHC data herring predators}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 10,
  fig.height = 8
)
```

This vignette shows how to extract and analyse the data for predators of Haida
Gwaii Pacific Herring, including lumping species together
(e.g. `all_skates`). This information is for a DFO Ecosystem Approach to
Fisheries Management Case Study on ecoystem influences of Haida Gwaii Pacific
Herring.

The area of interest is the same as shown in the [Restricted
area](vignettes/analysis_for_restricted_area.Rmd) vignette, and the shapefile is
saved in the package as `HG_herring_pred_area`.

```{r setup, results = FALSE}
library(gfiphc)
```

## Data for species of interest

First, just running for multiple individual species.


TODO Then re-run again with 2020 data added and 2018
expanded areas accounted for (may be done already for Series EF).

<!-- From Jen: -->
<!-- What would work best for me is a csv file with 3 columns: “Year”, “Indicator”, “Value”  -->
<!-- Non-standardized values are best. -->
<!-- The “Indicator” column could include:   -->
<!-- 1. ArrowtoothFlounder_IPHC_SurveyCatchRate  -->
<!-- 2. ArrowtoothFlounder_IPHC_UpperCI -->
<!-- 3. ArrowtoothFlounder_IPHC_LowerCI -->
<!-- 4. Rockfish_IPHC_SurveyCatchRate -->
<!-- 5. ... -->
<!-- ... -->


These are the original species (herring predators) extracted for Joe.
```{r definesp}
sp_vec <- c("yelloweye rockfish",
            "arrowtooth flounder",
            "lingcod",
            "north pacific spiny dogfish",
            "pacific cod",
            "pacific halibut",
            "redbanded rockfish",
            "sablefish",
            "longnose skate",
            "walleye pollock")
```

We want a general rockfish category and general skates one, I just picked
yelloweye, redbanded, and longnose as examples above. Going through groundfish
synopsis report and picking skate species, then rockfish, that have sufficient
data to look useful.

## Skate species

Looking through 2019 synopsis report, here are the decisions and comments on
including each skate species:

 - Aleutian Skate: Looks like only enumerated explicitly since 2007, 2018 map
   shows mean 0.31 fish/skate. Include (especially if lumped in an all-skate
   category early on? TODO check early IPHC data).
 - Abyssal Skate - no catch, ignore.
 - Broad Skate - no catch, ignore.
 - Big Skate - looks like enumerated explicitly since 1998, and 2018 map shows
   mean 0.69 fish/skate. Include.
 - Roughtail Skate - looks like only caught in 3 or four years (mean +ve sets
   1/177). No catch in 2018. Include (but look at numbers carefully first).
 - Sandpaper Skate - only shows up since 2003 (but not shown as zeros before
   that, just no data, TODO so look into). Mean +ve sets 5/177, 2018 mean 0.14 fish/skate. Include.
 - Longnose Skate - only shows up since 1998, mean +ve sets 57/135, 2018 mean
   0.96 fish/skate. Include.
 -  Alaska Skate - only showed up in four years, 2018 mean 0.14 fish/skate. Only
   plotted since 2003 (like Sandpaper), so TODO look into. Include even though
   rare.

```{r skatedefn}
skate_sp <- c("aleutian skate",
              "big skate",
              "roughtail skate",
              "sandpaper skate",
              "longnose skate",
              "alaska skate")
skate_ignore <- c("abyssal skate",
                  "broad skate")
```

Cache the data once (this is not evaluated each time):
```{r get_skates, eval=FALSE}
cache_pbs_data_iphc(skate_sp)
cache_pbs_data_iphc(skate_ignore)
```



TODO: were no skate enumerated in 1995 and 1996? If so then just use Series E -
check if the code does that automatically. And add an extra variable in the list
output to easily say which species it is (determined from p-value, but do in the
calculation function just the once).
chunk and just using what I saved for him.

Now want to lump the skates in `skate_sp` together. Merge two together manually
then write a function for that

```{r testing}
res <- get_combined_species(sp_vec = skate_sp)

summary(res$set_counts)

# Need to check how NA's pass through. Want them to stay NA's if true, but do we
# ever get N_it_sum = NA  when E_it != NA but usable = "Y"?

testthat::expect_equal(res$set_counts %>% dplyr::filter(is.na(N_it_sum) &
                                                        !is.na(E_it) & usable ==
                                                        "Y") %>%
                       nrow(),
                       0)

# And check the same for the 20-hook counts:
testthat::expect_equal(res$set_counts %>% dplyr::filter(is.na(N_it20_sum) &
                                                        !is.na(E_it20) & usable
                                                        == "Y") %>%
                       nrow(),
                       0)

res$set_counts %>% dplyr::select(-c("station", "lat", "lon", "usable", "standard")) %>%
  dplyr::summarise_all( ~ sum(is.na(.x))) %>%
    t()
```
Can see that the number of NA's is not the same for all species. See below for
each individual species. The figures show us that:

1. Skates were not identified to the species level in 1995 and 1996; however the
   data for then show "unident. Skate" so we can still maybe go back that far
   and need to include those when adding in. Need to check all years for
   mentions of skate.

1.

Next steps:
 - functionalise next bit, saving results (like in other vignette?)
 - show unident skate also
 - search all years for anything with skate
 - add unident and anything else to skate_sp, ensure consistent defns through time
 - create time series for combined skate_sp
 - create time series for the other predators
 - doing a combined rockfish one?
 - plot normalised values
 - create wrapper for format for Jennifer
 - go and get 2020 data.

## Individual skate species

Calculate series for each skate species in turn (saved as `species_name_area`)
and plot figures of Series E and F and longest from those:

```{r repeat, warning = FALSE}
for(sp in skate_sp){
  assign(sp_hyphenate(sp, underscore = TRUE, area = TRUE),
         iphc_get_calc_plot_area(sp))
}
```

## Individual non-skate species

```{r showmult, warning = FALSE}
# TODO replace by above function
for(sp in sp_vec){
  assign(sp_hyphenate(sp, underscore = TRUE, area = TRUE),
         iphc_get_calc_plot_area(sp))
}
```


Note that the code may not yet fully account for all possibilities (for all
areas and species), particularly for rarer species. So do check that the output
is sensible.

do analysis, with wrapper function for:
   - sp with area
   - series E and F
   - series EF

  plot results
  save results


show movie (link from other vignette)
