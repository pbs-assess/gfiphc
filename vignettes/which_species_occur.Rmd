---
title: "Which species occur in a given area over a given time?"
author: "Andrew Edwards"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Which species occur in a given area over a given time?}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 10,
  fig.height = 8
)
```

This vignette shows how to find out which species were caught in a given area
during a given time.

For this example, specifically asking what species were seen in the Strait of
Georgia in 2018, the only year in which the IPHC survey went into the
Strait (for Dick Beamish).




get all data for that year - can use my saved data but that's all by species, so
will have to loop through and extract the values.
 filter by station
 keep just those counts

```{r setup, results = FALSE}
load_all()
# library(gfiphc)
library(dplyr)

path_data = "all-species-data"                 # folder where have already saved
                                        # extracted raw data
# path_results = "HG-herring-predators-results"  # folder to save results
```

## Define species of interest (all in this case)

Want to check all species used in the groundfish synopsis report:
```{r species}
sp_vec <- gfsynopsis::get_spp_names() %>%
  dplyr::arrange(species_code) %>%
  dplyr::pull(species_common_name)
sp_vec
```

## Select only stations in Strait of Georgia

Easiest to look for new stations in 2018 that weren't in 2017, then just keep
the desired ones (using the saved `yelloweye_rockfish` data that includes all sets).

```{r stations}
sog_lon_range <- c(-126, -122)
sog_lat_range <- c(48.5, 50.6)

stations_in_2017 <- filter(yelloweye_rockfish$set_counts,
                           year == 2017)

stations_in_2018 <- filter(yelloweye_rockfish$set_counts,
                           year == 2018)

# Reduce to required stations, keeping yelloweye data for map plotting
stations_only_2018_yelloweye <- filter(stations_in_2018,
                                       !(station %in% stations_only_2017$station),
                                       lon > sog_lon_range[1],
                                       lat > sog_lat_range[1],
                                       lat < sog_lat_range[2],
                                       !(station %in% c("2206",
                                                        "2207",
                                                        "2209",
                                                        "2213",
                                                        "2217")))

stations_only_2018 <- pull(stations_only_2018_yelloweye,
                           station)

# To originally figure out the above stations to exclude:
# stations_only_2018_yelloweye %>% arrange(lat) %>% select(station, lat, lon)
# %>% as.data.frame()
stations_only_2018

# Confirm they are all usable:
expect_equal(stations_only_2018_yelloweye$usable,
             rep("Y", nrow(stations_only_2018_yelloweye)))
```

Now plot on a map

```{r map}
plot_BC(xlim = sog_lon_range,
        ylim = sog_lat_range,
        main = "All 2018 stations in Strait of Georgia")

plot_iphc_map(stations_only_2018_yelloweye,
              sp_short_name = NULL,
              years = 2018,
              add_to_existing = TRUE,
              indicate_standard = FALSE,
              include_legend = FALSE)
```

## Load cached data and extract numbers for just the Strait

Adapt this:

```{r extract}
for(sp in sp_vec){      # increment these to test, done up to number shown
  iphc_get_calc_plot_full(sp,
                          cached_data = TRUE,    # TRUE if data already saved
                          cached_results = TRUE, # TRUE if results already saved
                          print_sp_name = TRUE,
                          path_data = "all-species-data",
                          path_results = "all-species-results")
}



```{r repeat, warning = FALSE, results = FALSE}
cached_results = TRUE   # whether or not to use already-saved results (FALSE for
                        # first run)
for(sp in skate_sp){
  assign(sp_hyphenate(sp,
                      underscore = TRUE,
                      area = TRUE),
         iphc_get_calc_plot_area(sp,
                                 cached_data = cached_data,
                                 cached_results = cached_results,
                                 path_data = path_data,
                                 path_results = path_results))
}
```






## Merge together skate species

Now want to lump the skates in `skate_sp` together. Note that species counts get
named as `N_it.1` etc. While each one has NA's, none of the summed `N_it_sum` or
`N_it20_sum` do, because `get_combined_species()` ignores NA's when making the
sums. This is always recalculated (in case earlier cached data have changed).

```{r combine, warning = FALSE}
sp <- "skates combined"
skates_combined <- get_combined_species(sp_vec = skate_sp,
                                        path = path_data,
                                        save_RDS_name = sp_hyphenate(sp))
summary(skates_combined$set_counts)

# How many NA's in certain columns (none for N_it_sum or N_it20_sum
skates_combined$set_counts %>%
  dplyr::select(-c("station", "lat", "lon", "usable", "standard")) %>%
  dplyr::summarise_all( ~ sum(is.na(.x))) %>%
  t()
```
For 2021: these correctly change from the 2020 values (the 20-hook values don't
have more NA's than in 2020, but the all-hook values do, since we have no
all-hook data in 2021), except for `N_it20.4` for Sandpaper Skate, which had
1500 NA's in 2020 version but only 244 (same as some other species) in 2021
version. Looking at the relevant figure above, this is because 1997-2002 and
2013 are now zero when before they were NA, due to 2021 being the first
time this species was seen in 20-hook data (and how the data get rolled up). Not
checking for 2022.

Note that by simply adding the counts of each skate species, we are
implicitly assuming that selectivity is the same across skate species (kind of?). So true
changes in relative abundance may not be accurately reflected in changes in the
summed index.
<!-- Started an example: We are summing relative indices, so if one species (call it 'roller skate') is twice as
abundant as another (call it 'ice skate') but
has half the selectivity then their relative catch rates (fish per 100 hooks)
will be equal at, say, 1 fish per 100 hooks, given a summed rate of 2 fish per
100 hooks. But if roller skates double in abundance then ...  -->

Now use to calculate Series E, F and EF calculations for the restricted area:
```{r combineEF, warning = FALSE, results = FALSE}
assign(sp_hyphenate(sp, underscore = TRUE, area = TRUE),
       iphc_get_calc_plot_area(sp,
                               cached_data = cached_data,
                               cached_results = cached_results,
                               path_data = path_data,
                               path_results = path_results))
```


## Individual non-skate species

Similarly for the other species:
```{r showmult, warning = FALSE, results = FALSE}
for(sp in sp_vec){
  assign(sp_hyphenate(sp, underscore = TRUE, area = TRUE),
         iphc_get_calc_plot_area(sp,
                                 cached_data = cached_data,
                                 cached_results = cached_results,
                                 path_data = path_data,
                                 path_results = path_results))
}
```

## Format for Jennifer's EAFM summary

Save annual indices (with uncertainty) for all species of interest, in the
format for the HG herring predators' EAFM summary (some 2020 versions are in `for-jen-earlier-versions/`,
each later year will be saved along with everything else in `vignettes-results-20**-data/`.

```{r allsp}
all_sp_longest <- list()
sp_vec_and_combined_skates <- c(sp_vec, "skates combined")
# Do this to easily create arguments for iphc_format_for_EAFM(); can't easily
#  functionalise. Each element is names for the species, and is a tibble of
#  longest time series.
for(sp in sp_vec_and_combined_skates){
  all_sp_longest[[sp]] <- get(paste0(sp_hyphenate(sp,
                                                  underscore = TRUE,
                                                  area = TRUE)))$series_longest$ser_longest
}

eafm_res <- iphc_format_for_EAFM(sp_vec_and_combined_skates,
                                 path = path_results,
                                 all_sp_longest) # also saves .csv, and .rds of
                                                 #  all_sp_longest list

eafm_res
```

Note that the analyses may not yet fully account for all possibilities (for all
areas and species), particularly for rarer species. So do check that the output
is sensible by inspecting the above time series figures. And the analyses do not
(yet) include hook competition, which is currently being investigated.
