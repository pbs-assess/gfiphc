---
title: "Check the 2020 data and incorporate it into gfiphc"
author: "Andrew Edwards"
output: pdf_document
fontsize: 12pt
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = ">",
  fig.width = 10,
  fig.height = 8
)
```

In 2020 only the first 20 hooks were evaluated, so those data are not easily imported into
GFbio. Going to incorporate into gfiphc here. Likely need this as a template for
future years (resave this file with new year, and change all 2020's to the
subsequent year -- and go through the code somewhat manually to check the output
as you go along). This code includes some
manual checks to make sure the data look
okay.

For comparison first look at 2013 data included in gfiphc:
<!-- Based on iphc2013data.Rnw -->
```{r setup}
load_all()
setData2013
countData2013
```

We want to get the new data into the same format as those (columns with same
names and classes, even though in retrospect some classes aren't ideally
chosen, but also retaining retrieved and observed hooks for the set data). Two
data sets are
needed because later gfiphc code summarises catches of a particular species at the
station level, and needs to create counts of zeros for the species of interest
(and such zeros are not included in IPHC output).

## Set-level information

Maria was sent the file `2020 IPHCtoDFO_dataExtraction-Maria.xls` for set
details, but this is multiple sheets and more complex than needed. Will try
extracting directly from IPHC website (which they want us to do in the future
anyway), using the following instructions:

Go to https://www.iphc.int/data/fiss-data-query and select the following options:

1. Year Range -- 2020 to 2020.

2. Area 2B

3. Purpose Codes -- All

4. IPHC Charter Regions -- All

5. Maps -- Nothing

6. Select non-Pacific halibut species -- deselect All.

Download tab on bottom right (see instructions above question 4), and select
CrossTab. Select "Set and Pacific Halibut data" and .xlsx format (I tried .csv
format but it didn't save with commas, strangely). Save in this
folder as `set-and-halibut-data-2020.xlsx`. Open in Excel and Export as .csv, `set-and-halibut-data-2020.csv`,
and when trying to quit Excel say no to save changes (not sure if that matters).

Repeat but with all non-halibut data (select All in number 6), and save as
`non-halibut-data-2020.xlsx` and export as .csv in Excel,
`non-halibut-data-2020.csv`. Importantly, this file
(but not the first one) contains the numbers of observed hooks, needed in our
calculations.

```{r loadsetdata}
sets_raw <- readr::read_csv("set-and-halibut-data-2020.csv") %>%
  dplyr::mutate_if(is.character, factor)
sets_raw
summary(sets_raw)
testthat::expect_equal(unique(sets_raw$"IPHC Reg Area"), as.factor("2B")) # Check just BC
testthat::expect_equal(unique(sets_raw$Year), 2020)
```

Now simplify down to what's needed and rename, based on `iphc2013data.Rnw` (need
to include the 'purpose' column, unlike 2013):
```{r simplify}

sets_simp <- dplyr::select(sets_raw,
                           year = Year,
                           station = Station,
                           lat = "MidLat fished",
                           lon = "MidLon fished",
                           avgDepth = "AvgDepth (fm)",
                         # Need these from the other data set
                         #                    hooksRetr = HooksRetrieved,
                         #                    hooksObs = HooksObserved,
                           skatesHauled = "No. skates hauled",
                           effSkateIPHC = "Effective skates hauled",
                           soakTimeMinutes = "Soak time (min.)",  # Joe might want
                           usable = Eff,
                           purpose = Purpose) %>%
  arrange(station) %>%
  dplyr::mutate(year = as.integer(year),
                station = as.character(station),
                avgDepth = as.integer(avgDepth),
                usable = as.character(usable))

sets_simp
```

Then change purpose to `standard` (`Y/N`) to match 2018 data (`Y` for the
standard grid). Here `purpose` takes three values, and we need to convert to
`standard`:
```{r purpose}
summary(sets_simp$purpose)

sets_simp_std <- dplyr::mutate(sets_simp,
                               standard_tmp = (purpose == "Standard grid"))

standard <- as.character(sets_simp_std$standard_tmp)  # to get the right length
standard[sets_simp_std$standard_tmp] = "Y"
standard[!sets_simp_std$standard_tmp] = "N"

sets_simp_std <- cbind(sets_simp_std,
                   standard) %>%
  as_tibble() %>%
  dplyr::select(-c("standard_tmp"))
summary(sets_simp_std)
```

## Species counts

First, get the species counts into the desired format (to match `countData2013` shown earlier):
```{r counts}
counts_raw <- readr::read_csv("non-halibut-data-2020.csv") %>%
  dplyr::mutate_if(is.character, factor)

counts_raw
summary(counts_raw)
testthat::expect_equal(unique(counts_raw$Year), 2020)
testthat::expect_equal(unique(counts_raw$SampleType), as.factor("20Hook"))
countData2020 <- dplyr::select(counts_raw,
                               year = Year,
                               station = Station,
                               spNameIPHC = "Species Name",
                               specCount = "Number Observed") %>%
  arrange(station) %>%
  dplyr::mutate(year = as.integer(year),
                station = as.character(station),
                spNameIPHC = as.character(spNameIPHC),
                specCount = as.integer(specCount))

testthat::expect_equal(names(countData2013), names(countData2020))
countData2020
summary(countData2020)

usethis::use_data(countData2020,
                  overwrite = TRUE)

```

## Hooks observed and retrieved

Now, obtain the numbers of hooks observed and retrieved from `counts_raw`, to
then merge into the set details:
```{r hookdetails}
hook_details <- dplyr::group_by(counts_raw,
                                Station) %>%
  dplyr::summarise(year = unique(Year),
                   hooksRetr = unique(HooksRetrieved),
                   hooksObs = unique(HooksObserved)) %>%
  dplyr::rename(station = Station) %>%
  dplyr::ungroup() %>%
  arrange(station) %>%
  dplyr::mutate(year = as.integer(year),
                station = as.character(station))

hook_details

expect_equal(sets_simp_std$station, hook_details$station)
```

So now need to get the hook details into the set details, and keep columns as
for `setData2013` but also with `standard`, and may as weel keep `hooksRetr` and
`hooksObs`:
```{r merge}
setData2020 <- dplyr::left_join(sets_simp_std,
                                hook_details,
                                by = c("year", "station")) %>%
  dplyr::mutate(E_it20 = effSkateIPHC * hooksObs / hooksRetr) %>%
  dplyr::select(year,
                station,
                lat,
                lon,
                avgDepth,
                effSkateIPHC,
                E_it20,
                usable,
                standard,
                hooksRetr,
                hooksObs) %>%
  dplyr::mutate(year = as.integer(year),
                station = as.character(station),
                avgDepth = as.integer(avgDepth),
                usable = as.character(usable),
                standard = as.factor(usable))
setData2020
testthat::expect_equal(names(setData2013), names(setData2020)[1:ncol(setData2013)])
summary(setData2020)
usethis::use_data(setData2020,
                  overwrite = TRUE)
```
